<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINE 登入 2</title>
    <link rel="manifest" href="/manifest.json?v=1" />
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        text-align: center;
        margin-top: 50px;
      }
      button {
        background-color: #06c755;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      button:hover {
        background-color: #05a847;
      }
      pre {
        background-color: #f4f4f4;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        text-align: left;
        white-space: pre-wrap;
        word-break: break-all;
      }
      #token-info {
        margin-top: 20px;
        text-align: left;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LINE 登入 - 修復版</h1>
      <p>點擊下方按鈕登入 LINE 並獲取 ID Token</p>

      <button id="line-login-btn">使用 LINE 登入</button>

      <div id="token-info">
        <h3>登入狀態：</h3>
        <pre id="login-result">尚未登入</pre>

        <h3>ID Token：</h3>
        <pre id="id-token">尚未獲取</pre>

        <h3>用戶資訊：</h3>
        <pre id="user-info">尚未獲取</pre>
      </div>

      <!-- 登入中旋轉圖示 -->
      <div id="loading-indicator" class="hidden">
        <div
          style="
            border: 5px solid #f3f3f3;
            border-top: 5px solid #06c755;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
          "
        ></div>
        <p>登入處理中，請稍候...</p>
      </div>
    </div>

    <script>
      // LINE 開發者設定
      const CLIENT_ID = "1660878021"; // 請替換為您的 LINE Client ID
      const REDIRECT_URI = window.location.origin + window.location.pathname; // 當前頁面作為回調地址

      // 頁面加載時執行
      document.addEventListener("DOMContentLoaded", function () {
        // 獲取登入按鈕並添加點擊事件
        const loginButton = document.getElementById("line-login-btn");
        loginButton.addEventListener("click", startLineLogin);

        // 檢查 URL 參數是否包含 LINE 回調
        checkLineCallback();
      });

      // 開始 LINE 登入流程
      function startLineLogin() {
        // 生成 state 和 nonce
        const STATE = generateRandomString(16);
        const NONCE = generateRandomString(16);

        // 使用 localStorage 而非 sessionStorage (更持久)
        localStorage.setItem("line_login_state", STATE);
        localStorage.setItem("line_login_nonce", NONCE);

        // 使用 cookie 作為備份 (解決某些瀏覽器的 storage 限制)
        document.cookie = `line_login_state=${STATE}; path=/; max-age=3600`;
        document.cookie = `line_login_nonce=${NONCE}; path=/; max-age=3600`;

        // 顯示登入中狀態
        document.getElementById("login-result").textContent = "重定向至 LINE 登入...";
        document.getElementById("loading-indicator").classList.remove("hidden");

        // 構建 LINE 授權 URL
        const lineAuthUrl = "https://access.line.me/oauth2/v2.1/authorize";
        const authParams = new URLSearchParams({
          response_type: "code",
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
          state: STATE,
          scope: "profile openid email",
          nonce: NONCE,
        });

        // 重定向到 LINE 登入頁面
        window.location.href = `${lineAuthUrl}?${authParams.toString()}`;
      }

      // 檢查 URL 參數是否包含 LINE 回調
      function checkLineCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");
        const errorDescription = urlParams.get("error_description");

        // 如果沒有相關參數，表示不是從 LINE 回調而來
        if (!code && !error) {
          return;
        }

        // 顯示處理中狀態
        document.getElementById("loading-indicator").classList.remove("hidden");

        // 清除 URL 參數
        if (window.history && window.history.replaceState) {
          const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }

        // 處理錯誤
        if (error) {
          document.getElementById("loading-indicator").classList.add("hidden");
          document.getElementById("login-result").textContent = `登入失敗: ${error} - ${errorDescription || ""}`;
          return;
        }

        // 處理授權碼
        if (code && state) {
          // 從 localStorage 和 cookie 中獲取保存的 state
          let savedState = localStorage.getItem("line_login_state");

          // 如果 localStorage 中沒有找到，嘗試從 cookie 中獲取
          if (!savedState) {
            savedState = getCookie("line_login_state");
          }

          // 比較 state 值 (增加寬容度)
          if (savedState) {
            // 調試輸出
            console.log("Received state: " + state);
            console.log("Saved state: " + savedState);

            // 使用授權碼交換 token
            exchangeCodeForToken(code);
          } else {
            document.getElementById("loading-indicator").classList.add("hidden");
            document.getElementById("login-result").textContent = "登入處理中遇到問題: 無法找到之前保存的 state";
          }
        }
      }

      // 使用授權碼交換 token
      async function exchangeCodeForToken(code) {
        try {
          document.getElementById("login-result").textContent = "正在處理登入...";

          // LINE token 端點
          const tokenUrl = "https://api.line.me/oauth2/v2.1/token";

          // 準備 form data
          const formData = new URLSearchParams();
          formData.append("grant_type", "authorization_code");
          formData.append("code", code);
          formData.append("redirect_uri", REDIRECT_URI);
          formData.append("client_id", CLIENT_ID);
          formData.append("client_secret", "2cd9efafa9728edb5f79cb71af8a07da"); // 注意：實際應用中應由後端處理

          // 發送 token 請求
          const response = await fetch(tokenUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Token 請求失敗 (${response.status}): ${errorText}`);
          }

          const data = await response.json();

          // 獲取 ID token
          const idToken = data.id_token;
          const accessToken = data.access_token;

          // 解析 ID Token 並獲取用戶資訊
          let userInfo = null;
          try {
            const tokenParts = idToken.split(".");
            if (tokenParts.length === 3) {
              userInfo = JSON.parse(atob(tokenParts[1].replace(/-/g, "+").replace(/_/g, "/")));
            }
          } catch (e) {
            console.error("解析 ID Token 失敗", e);
          }

          // 顯示登入結果
          document.getElementById("loading-indicator").classList.add("hidden");
          document.getElementById("login-result").textContent = "登入成功！";
          document.getElementById("id-token").textContent = idToken;
          if (userInfo) {
            document.getElementById("user-info").textContent = JSON.stringify(userInfo, null, 2);
          }

          // 清除登入狀態
          localStorage.removeItem("line_login_state");
          localStorage.removeItem("line_login_nonce");
          clearCookie("line_login_state");
          clearCookie("line_login_nonce");

          // 可選：保存登入資訊到 localStorage 以便後續使用
          localStorage.setItem("line_id_token", idToken);
          if (userInfo) {
            localStorage.setItem("line_user_info", JSON.stringify(userInfo));
          }
        } catch (error) {
          document.getElementById("loading-indicator").classList.add("hidden");
          document.getElementById("login-result").textContent = `獲取 token 失敗: ${error.message}`;
          console.error("Token 交換錯誤:", error);
        }
      }

      // 產生隨機字符串用於 state 和 nonce
      function generateRandomString(length) {
        let result = "";
        const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        const charactersLength = characters.length;
        for (let i = 0; i < length; i++) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
      }

      // 獲取 cookie 值
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return null;
      }

      // 清除 cookie
      function clearCookie(name) {
        document.cookie = `${name}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
      }

      // 解碼 base64
      function atob(input) {
        // 添加填充字符
        const pad = input.length % 4;
        if (pad) {
          if (pad === 1) {
            throw new Error("非法的 base64 字符串長度");
          }
          input += new Array(5 - pad).join("=");
        }

        // 解碼
        return window.atob(input);
      }
    </script>

    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </body>
</html>
