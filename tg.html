<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram WebApp è¨ºæ–·å·¥å…·</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        padding: 16px;
        line-height: 1.4;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 12px;
      }

      .section {
        margin-bottom: 24px;
        padding: 16px;
        background: var(--tg-theme-secondary-bg-color, #f8f8f8);
        border-radius: 12px;
        border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      }

      .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 12px;
        color: var(--tg-theme-link-color, #0066cc);
      }

      .property {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      }

      .property:last-child {
        border-bottom: none;
      }

      .property-name {
        font-weight: 500;
        flex: 1;
      }

      .property-value {
        font-family: "Courier New", monospace;
        background: var(--tg-theme-bg-color, #ffffff);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .status {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }

      .status.supported {
        background: #4caf50;
        color: white;
      }

      .status.not-supported {
        background: #f44336;
        color: white;
      }

      .status.partial {
        background: #ff9800;
        color: white;
      }

      .status.unknown {
        background: #9e9e9e;
        color: white;
      }

      .method-test {
        margin-top: 8px;
        padding: 8px;
        background: var(--tg-theme-bg-color, #ffffff);
        border-radius: 4px;
        border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      }

      .btn {
        background: var(--tg-theme-button-color, #0066cc);
        color: var(--tg-theme-button-text-color, #ffffff);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 4px;
      }

      .btn:hover {
        opacity: 0.8;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .log {
        background: #000;
        color: #00ff00;
        padding: 12px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 12px;
      }

      .expandable {
        cursor: pointer;
        user-select: none;
      }

      .expandable:before {
        content: "â–¶ ";
        display: inline-block;
        transition: transform 0.2s;
      }

      .expandable.expanded:before {
        transform: rotate(90deg);
      }

      .expandable-content {
        display: none;
        margin-top: 8px;
        padding-left: 16px;
      }

      .expandable.expanded + .expandable-content {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ” Telegram WebApp è¨ºæ–·å·¥å…·</h1>
        <p>æª¢æŸ¥ Telegram WebApp API çš„æ”¯æ´ç¨‹åº¦å’Œå¯ç”¨åŠŸèƒ½</p>
      </div>

      <!-- åŸºæœ¬è³‡è¨Š -->
      <div class="section">
        <h2 class="section-title">ğŸ“± åŸºæœ¬è³‡è¨Š</h2>
        <div id="basic-info"></div>
      </div>

      <!-- æ ¸å¿ƒå±¬æ€§ -->
      <div class="section">
        <h2 class="section-title">âš™ï¸ æ ¸å¿ƒå±¬æ€§</h2>
        <div id="core-properties"></div>
      </div>

      <!-- ä½¿ç”¨è€…è³‡è¨Š -->
      <div class="section">
        <h2 class="section-title">ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š</h2>
        <div id="user-info"></div>
      </div>

      <!-- è£ç½®å’Œç’°å¢ƒ -->
      <div class="section">
        <h2 class="section-title">ğŸ“± è£ç½®å’Œç’°å¢ƒ</h2>
        <div id="device-info"></div>
      </div>

      <!-- æŒ‰éˆ•å’Œæ§åˆ¶ -->
      <div class="section">
        <h2 class="section-title">ğŸ›ï¸ æŒ‰éˆ•å’Œæ§åˆ¶</h2>
        <div id="buttons-info"></div>
      </div>

      <!-- æ–°åŠŸèƒ½æª¢æ¸¬ -->
      <div class="section">
        <h2 class="section-title">ğŸ†• æ–°åŠŸèƒ½æ”¯æ´</h2>
        <div id="new-features"></div>
      </div>

      <!-- æ–¹æ³•æ¸¬è©¦ -->
      <div class="section">
        <h2 class="section-title">ğŸ§ª æ–¹æ³•æ¸¬è©¦</h2>
        <div id="method-tests"></div>
      </div>

      <!-- äº‹ä»¶ç›£è½ -->
      <div class="section">
        <h2 class="section-title">ğŸ“¡ äº‹ä»¶ç›£è½</h2>
        <div id="events-info"></div>
        <div class="log" id="event-log"></div>
      </div>

      <!-- JSON è¼¸å‡º -->
      <div class="section">
        <h2 class="section-title expandable" onclick="toggleExpandable(this)">ğŸ“„ å®Œæ•´ JSON è¼¸å‡º</h2>
        <div class="expandable-content">
          <pre id="json-output" class="log"></pre>
        </div>
      </div>
    </div>

    <script>
      let eventLog = [];

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        eventLog.push(`[${timestamp}] ${message}`);
        updateEventLog();
      }

      function updateEventLog() {
        const logElement = document.getElementById("event-log");
        logElement.textContent = eventLog.slice(-20).join("\n");
        logElement.scrollTop = logElement.scrollHeight;
      }

      function getStatus(value) {
        if (value === undefined || value === null) {
          return '<span class="status not-supported">ä¸æ”¯æ´</span>';
        }
        if (typeof value === "function") {
          return '<span class="status supported">æ–¹æ³•å¯ç”¨</span>';
        }
        if (typeof value === "boolean") {
          return value
            ? '<span class="status supported">True</span>'
            : '<span class="status not-supported">False</span>';
        }
        return '<span class="status supported">å¯ç”¨</span>';
      }

      function createProperty(name, value, description = "") {
        const status = getStatus(value);
        const displayValue =
          value === undefined
            ? "undefined"
            : value === null
            ? "null"
            : typeof value === "function"
            ? "function()"
            : typeof value === "object"
            ? JSON.stringify(value).substring(0, 50) + "..."
            : String(value);

        return `
                <div class="property">
                    <div class="property-name">
                        ${name}
                        ${description ? `<br><small style="color: #666;">${description}</small>` : ""}
                    </div>
                    <div>
                        ${status}
                        <div class="property-value">${displayValue}</div>
                    </div>
                </div>
            `;
      }

      function toggleExpandable(element) {
        element.classList.toggle("expanded");
      }

      function diagnose() {
        const tg = window.Telegram?.WebApp;

        if (!tg) {
          document.body.innerHTML =
            '<div class="container"><div class="header"><h1>âŒ Telegram WebApp ä¸å¯ç”¨</h1><p>è«‹åœ¨ Telegram ä¸­é–‹å•Ÿæ­¤é é¢</p></div></div>';
          return;
        }

        // åŸºæœ¬è³‡è¨Š
        document.getElementById("basic-info").innerHTML = `
                ${createProperty("WebApp ç‰©ä»¶", tg ? "å¯ç”¨" : "ä¸å¯ç”¨")}
                ${createProperty("ç‰ˆæœ¬", tg.version, "Telegram WebApp API ç‰ˆæœ¬")}
                ${createProperty("å¹³å°", tg.platform, "é‹è¡Œå¹³å° (android/ios/desktopç­‰)")}
                ${createProperty("åˆå§‹åŒ–", tg.isExpanded, "æ˜¯å¦å·²å±•é–‹")}
                ${createProperty("æº–å‚™ç‹€æ…‹", tg.ready ? "å·²æº–å‚™" : "æœªæº–å‚™")}
            `;

        // æ ¸å¿ƒå±¬æ€§
        document.getElementById("core-properties").innerHTML = `
                ${createProperty("colorScheme", tg.colorScheme, "é¡è‰²ä¸»é¡Œ")}
                ${createProperty("themeParams", tg.themeParams, "ä¸»é¡Œåƒæ•¸")}
                ${createProperty("isExpanded", tg.isExpanded, "æ˜¯å¦å±•é–‹æ¨¡å¼")}
                ${createProperty("viewportHeight", tg.viewportHeight, "è¦–çª—é«˜åº¦")}
                ${createProperty("viewportStableHeight", tg.viewportStableHeight, "ç©©å®šè¦–çª—é«˜åº¦")}
                ${createProperty("headerColor", tg.headerColor, "æ¨™é¡Œåˆ—é¡è‰²")}
                ${createProperty("backgroundColor", tg.backgroundColor, "èƒŒæ™¯é¡è‰²")}
                ${createProperty("isClosingConfirmationEnabled", tg.isClosingConfirmationEnabled, "é—œé–‰ç¢ºèª")}
                ${createProperty("isVerticalSwipesEnabled", tg.isVerticalSwipesEnabled, "å‚ç›´æ»‘å‹•")}
            `;

        // ä½¿ç”¨è€…è³‡è¨Š
        const user = tg.initDataUnsafe?.user;
        document.getElementById("user-info").innerHTML = `
                ${createProperty("initData", tg.initData ? "æœ‰è³‡æ–™" : "ç„¡è³‡æ–™", "åˆå§‹åŒ–è³‡æ–™")}
                ${createProperty("initDataUnsafe", tg.initDataUnsafe ? "æœ‰è³‡æ–™" : "ç„¡è³‡æ–™", "æœªåŠ å¯†åˆå§‹åŒ–è³‡æ–™")}
                ${createProperty("ä½¿ç”¨è€… ID", user?.id, "ç•¶å‰ä½¿ç”¨è€… ID")}
                ${createProperty("ä½¿ç”¨è€…åç¨±", user?.first_name, "ä½¿ç”¨è€…åå­—")}
                ${createProperty("ç”¨æˆ¶å", user?.username, "Telegram ç”¨æˆ¶å")}
                ${createProperty("èªè¨€ä»£ç¢¼", user?.language_code, "ä½¿ç”¨è€…èªè¨€")}
                ${createProperty("é ­åƒ URL", user?.photo_url, "ä½¿ç”¨è€…é ­åƒ")}
                ${createProperty("Premium ç”¨æˆ¶", user?.is_premium, "æ˜¯å¦ç‚º Premium ç”¨æˆ¶")}
            `;

        // è£ç½®å’Œç’°å¢ƒè³‡è¨Š
        document.getElementById("device-info").innerHTML = `
                ${createProperty("safeAreaInset", tg.safeAreaInset, "å®‰å…¨å€åŸŸå…§é‚Šè·")}
                ${createProperty("contentSafeAreaInset", tg.contentSafeAreaInset, "å…§å®¹å®‰å…¨å€åŸŸ")}
                ${createProperty("isActive", tg.isActive, "WebApp æ˜¯å¦æ´»èº")}
                ${createProperty("isFullscreen", tg.isFullscreen, "æ˜¯å¦å…¨è¢å¹•æ¨¡å¼")}
                ${createProperty("isOrientationLocked", tg.isOrientationLocked, "è¢å¹•æ–¹å‘æ˜¯å¦é–å®š")}
                ${createProperty("deviceOrientation", tg.DeviceOrientation, "è£ç½®æ–¹å‘æ„Ÿæ¸¬å™¨")}
                ${createProperty("accelerometer", tg.Accelerometer, "åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨")}
                ${createProperty("gyroscope", tg.Gyroscope, "é™€èºå„€æ„Ÿæ¸¬å™¨")}
            `;

        // æŒ‰éˆ•å’Œæ§åˆ¶
        document.getElementById("buttons-info").innerHTML = `
                ${createProperty("MainButton", tg.MainButton, "ä¸»æŒ‰éˆ•")}
                ${createProperty("SecondaryButton", tg.SecondaryButton, "æ¬¡è¦æŒ‰éˆ•")}
                ${createProperty("BackButton", tg.BackButton, "è¿”å›æŒ‰éˆ•")}
                ${createProperty("SettingsButton", tg.SettingsButton, "è¨­å®šæŒ‰éˆ•")}
                ${createProperty("HapticFeedback", tg.HapticFeedback, "è§¸è¦ºå›é¥‹")}
                ${createProperty("CloudStorage", tg.CloudStorage, "é›²ç«¯å„²å­˜")}
                ${createProperty("BiometricManager", tg.BiometricManager, "ç”Ÿç‰©è¾¨è­˜ç®¡ç†")}
            `;

        // æ–°åŠŸèƒ½
        document.getElementById("new-features").innerHTML = `
                ${createProperty("addToHomeScreen", tg.addToHomeScreen, "æ·»åŠ åˆ°ä¸»è¢å¹•")}
                ${createProperty("checkHomeScreenStatus", tg.checkHomeScreenStatus, "æª¢æŸ¥ä¸»è¢å¹•ç‹€æ…‹")}
                ${createProperty("requestFullscreen", tg.requestFullscreen, "è«‹æ±‚å…¨è¢å¹•")}
                ${createProperty("exitFullscreen", tg.exitFullscreen, "é€€å‡ºå…¨è¢å¹•")}
                ${createProperty("lockOrientation", tg.lockOrientation, "é–å®šè¢å¹•æ–¹å‘")}
                ${createProperty("unlockOrientation", tg.unlockOrientation, "è§£é–è¢å¹•æ–¹å‘")}
                ${createProperty("LocationManager", tg.LocationManager, "ä½ç½®ç®¡ç†")}
                ${createProperty("downloadFile", tg.downloadFile, "æª”æ¡ˆä¸‹è¼‰")}
                ${createProperty("shareToStory", tg.shareToStory, "åˆ†äº«åˆ°å‹•æ…‹")}
                ${createProperty("switchInlineQuery", tg.switchInlineQuery, "åˆ‡æ›å…§è¯æŸ¥è©¢")}
                ${createProperty("invokeCustomMethod", tg.invokeCustomMethod, "å‘¼å«è‡ªå®šç¾©æ–¹æ³•")}
            `;

        // æ–¹æ³•æ¸¬è©¦
        setupMethodTests(tg);

        // è¨­å®šäº‹ä»¶ç›£è½
        setupEventListeners(tg);

        // JSON è¼¸å‡º
        document.getElementById("json-output").textContent = JSON.stringify(
          {
            version: tg.version,
            platform: tg.platform,
            user: tg.initDataUnsafe?.user,
            themeParams: tg.themeParams,
            viewportHeight: tg.viewportHeight,
            capabilities: {
              addToHomeScreen: !!tg.addToHomeScreen,
              fullscreen: !!(tg.requestFullscreen && tg.exitFullscreen),
              cloudStorage: !!tg.CloudStorage,
              biometrics: !!tg.BiometricManager,
              haptics: !!tg.HapticFeedback,
              location: !!tg.LocationManager,
              deviceSensors: !!(tg.Accelerometer || tg.Gyroscope),
            },
          },
          null,
          2
        );

        log("è¨ºæ–·å®Œæˆ");
      }

      function setupMethodTests(tg) {
        const tests = [
          {
            name: "å±•é–‹ WebApp",
            method: "expand",
            test: () => tg.expand(),
          },
          {
            name: "é—œé–‰ WebApp",
            method: "close",
            test: () => confirm("ç¢ºå®šè¦é—œé–‰ WebApp å—ï¼Ÿ") && tg.close(),
          },
          {
            name: "é¡¯ç¤ºä¸»æŒ‰éˆ•",
            method: "MainButton.show",
            test: () => {
              tg.MainButton.setText("æ¸¬è©¦æŒ‰éˆ•");
              tg.MainButton.show();
              log("ä¸»æŒ‰éˆ•å·²é¡¯ç¤º");
            },
          },
          {
            name: "éš±è—ä¸»æŒ‰éˆ•",
            method: "MainButton.hide",
            test: () => {
              tg.MainButton.hide();
              log("ä¸»æŒ‰éˆ•å·²éš±è—");
            },
          },
          {
            name: "è§¸è¦ºå›é¥‹",
            method: "HapticFeedback.impactOccurred",
            test: () => {
              tg.HapticFeedback?.impactOccurred?.("medium");
              log("è§¸è¦ºå›é¥‹å·²è§¸ç™¼");
            },
          },
          {
            name: "æ·»åŠ åˆ°ä¸»è¢å¹•",
            method: "addToHomeScreen",
            test: () => {
              if (tg.addToHomeScreen) {
                const status = tg.checkHomeScreenStatus?.() || "unknown";
                log(`ä¸»è¢å¹•ç‹€æ…‹: ${status}`);
                if (status === "supported") {
                  tg.addToHomeScreen();
                  log("å˜—è©¦æ·»åŠ åˆ°ä¸»è¢å¹•");
                } else {
                  log("è£ç½®ä¸æ”¯æ´æ·»åŠ åˆ°ä¸»è¢å¹•");
                }
              } else {
                log("addToHomeScreen æ–¹æ³•ä¸å¯ç”¨");
              }
            },
          },
          {
            name: "å…¨è¢å¹•æ¨¡å¼",
            method: "requestFullscreen",
            test: () => {
              if (tg.requestFullscreen) {
                tg.requestFullscreen();
                log("è«‹æ±‚å…¨è¢å¹•æ¨¡å¼");
              } else {
                log("å…¨è¢å¹•åŠŸèƒ½ä¸å¯ç”¨");
              }
            },
          },
          {
            name: "è®€å–å‰ªè²¼ç°¿",
            method: "readTextFromClipboard",
            test: () => {
              if (tg.readTextFromClipboard) {
                tg.readTextFromClipboard((text) => {
                  log(`å‰ªè²¼ç°¿å…§å®¹: ${text}`);
                });
              } else {
                log("è®€å–å‰ªè²¼ç°¿åŠŸèƒ½ä¸å¯ç”¨");
              }
            },
          },
          {
            name: "æª¢æŸ¥ä¸»è¢å¹•ç‹€æ…‹",
            method: "checkHomeScreenStatus",
            test: () => {
              if (tg.checkHomeScreenStatus) {
                const status = tg.checkHomeScreenStatus();
                log(`ä¸»è¢å¹•ç‹€æ…‹: ${status}`);
                log(`ç‹€æ…‹èªªæ˜: ${status === 'supported' ? 'æ”¯æ´æ·»åŠ åˆ°ä¸»è¢å¹•' : status === 'unsupported' ? 'ä¸æ”¯æ´æ·»åŠ åˆ°ä¸»è¢å¹•' : status === 'added' ? 'å·²æ·»åŠ åˆ°ä¸»è¢å¹•' : 'æœªçŸ¥ç‹€æ…‹'}`);
              } else {
                log("checkHomeScreenStatus æ–¹æ³•ä¸å¯ç”¨");
              }
            },
          },
          {
            name: "æ¸¬è©¦ <a> æ¨™ç±¤ target=\"_blank\"",
            method: "a_blank",
            test: () => {
              const testLink = document.createElement('a');
              testLink.href = 'https://www.google.com';
              testLink.target = '_blank';
              testLink.textContent = 'é–‹å•Ÿ Google (a href + _blank)';
              testLink.className = 'btn';
              testLink.style.cssText = 'display: inline-block; text-decoration: none;';
              
              // ä¸ä½¿ç”¨ preventDefaultï¼Œè®“ <a> æ¨™ç±¤æ­£å¸¸å·¥ä½œ
              testLink.onclick = () => {
                log('é»æ“Š <a> æ¨™ç±¤ - href="https://www.google.com" target="_blank"');
                // è®“ç€è¦½å™¨è™•ç† <a> æ¨™ç±¤çš„é»˜èªè¡Œç‚º
              };
              
              const testDiv = document.createElement('div');
              testDiv.innerHTML = `<p>é»æ“Šä¸‹æ–¹é€£çµæ¸¬è©¦ &lt;a href="https://www.google.com" target="_blank"&gt;ï¼š</p><br>`;
              testDiv.appendChild(testLink);
              
              const existingTest = document.getElementById('a-blank-test');
              if (existingTest) {
                existingTest.remove();
              }
              
              testDiv.id = 'a-blank-test';
              testDiv.style.cssText = 'margin-top: 10px; padding: 10px; background: var(--tg-theme-bg-color, #fff); border-radius: 4px;';
              
              const methodTests = document.getElementById('method-tests');
              if (!methodTests) {
                log('éŒ¯èª¤: æ‰¾ä¸åˆ° method-tests å…ƒç´ ');
                return;
              }
              methodTests.appendChild(testDiv);
              
              log('å·²ç”Ÿæˆ <a> æ¨™ç±¤æ¸¬è©¦é€£çµï¼Œtarget="_blank"');
            },
          },
          {
            name: "æ¸¬è©¦ window.open _blank",
            method: "window_open",
            test: () => {
              const testButton = document.createElement('button');
              testButton.textContent = 'é–‹å•Ÿ Google (window.open)';
              testButton.className = 'btn';
              
              testButton.onclick = () => {
                log('é»æ“Š window.open æŒ‰éˆ•');
                try {
                  log('å˜—è©¦ä½¿ç”¨ window.open é–‹å•Ÿ: https://www.google.com');
                  const newWindow = window.open('https://www.google.com', '_blank');
                  
                  if (newWindow) {
                    log('window.open æˆåŠŸ - æ–°è¦–çª—å·²é–‹å•Ÿ');
                  } else {
                    log('window.open å¤±æ•— - å¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹æˆ–ä¸æ”¯æ´');
                  }
                } catch (error) {
                  log(`window.open æ¸¬è©¦å¤±æ•—: ${error.message}`);
                }
              };
              
              const testDiv = document.createElement('div');
              testDiv.innerHTML = `<p>ä½¿ç”¨ window.open é–‹å•Ÿ Googleï¼š</p><br>`;
              testDiv.appendChild(testButton);
              
              const existingTest = document.getElementById('window-open-test');
              if (existingTest) {
                existingTest.remove();
              }
              
              testDiv.id = 'window-open-test';
              testDiv.style.cssText = 'margin-top: 10px; padding: 10px; background: var(--tg-theme-bg-color, #fff); border-radius: 4px;';
              
              const methodTests = document.getElementById('method-tests');
              methodTests.appendChild(testDiv);
              
              log('å·²æ·»åŠ  window.open æ¸¬è©¦æŒ‰éˆ•');
            },
          },
        ];

        const testsHtml = tests
          .map((test, index) => {
            let available;
            // ç‰¹æ®Šè™•ç†æˆ‘å€‘è‡ªå®šç¾©çš„æ¸¬è©¦
            if (test.method === "a_blank" || test.method === "window_open") {
              available = true; // é€™å…©å€‹æ¸¬è©¦å§‹çµ‚å¯ç”¨
            } else {
              available = test.method.split(".").reduce((obj, prop) => obj?.[prop], tg);
            }
            return `
                    <div class="method-test">
                        <strong>${test.name}</strong> ${getStatus(available)}
                        <br>
                        <button class="btn" onclick="runTestByIndex(${index})" ${!available ? "disabled" : ""}>
                            æ¸¬è©¦
                        </button>
                    </div>
                `;
          })
          .join("");

        document.getElementById("method-tests").innerHTML = testsHtml;

        // å„²å­˜æ¸¬è©¦å‡½æ•¸åˆ°å…¨åŸŸ
        window.testFunctions = {};
        window.testsList = tests;
        tests.forEach((test) => {
          window.testFunctions[test.name] = test.test;
        });
      }

      function runTestByIndex(index) {
        try {
          const test = window.testsList[index];
          if (!test) {
            log(`éŒ¯èª¤: æ‰¾ä¸åˆ°ç´¢å¼• ${index} çš„æ¸¬è©¦`);
            return;
          }
          log(`åŸ·è¡Œæ¸¬è©¦: ${test.name}`);
          console.log(`Debug: åŸ·è¡Œæ¸¬è©¦ ${test.name}`);
          test.test();
          log(`æ¸¬è©¦ ${test.name} åŸ·è¡Œå®Œæˆ`);
        } catch (error) {
          log(`æ¸¬è©¦å¤±æ•—: ç´¢å¼• ${index} - ${error.message}`);
          console.error(`Debug: æ¸¬è©¦å¤±æ•—`, error);
        }
      }

      function runTest(testName) {
        try {
          log(`åŸ·è¡Œæ¸¬è©¦: ${testName}`);
          console.log(`Debug: åŸ·è¡Œæ¸¬è©¦ ${testName}`);
          if (!window.testFunctions) {
            log(`éŒ¯èª¤: testFunctions æœªåˆå§‹åŒ–`);
            return;
          }
          if (!window.testFunctions[testName]) {
            log(`éŒ¯èª¤: æ‰¾ä¸åˆ°æ¸¬è©¦å‡½æ•¸ ${testName}`);
            return;
          }
          window.testFunctions[testName]();
          log(`æ¸¬è©¦ ${testName} åŸ·è¡Œå®Œæˆ`);
        } catch (error) {
          log(`æ¸¬è©¦å¤±æ•—: ${testName} - ${error.message}`);
          console.error(`Debug: æ¸¬è©¦å¤±æ•—`, error);
        }
      }

      function setupEventListeners(tg) {
        const events = [
          "themeChanged",
          "viewportChanged",
          "mainButtonClicked",
          "secondaryButtonClicked",
          "backButtonClicked",
          "settingsButtonClicked",
          "invoiceRequestClosed",
          "popupClosed",
          "qrTextReceived",
          "clipboardTextReceived",
          "writeAccessRequested",
          "contactRequested",
          "biometricManagerUpdated",
          "biometricAuthRequested",
          "biometricTokenUpdated",
          "activated",
          "deactivated",
          "safeAreaChanged",
          "contentSafeAreaChanged",
          "fullscreenChanged",
          "fullscreenFailed",
          "homeScreenAdded",
          "homeScreenChecked",
        ];

        let listenedEvents = 0;
        events.forEach((event) => {
          try {
            tg.onEvent(event, (data) => {
              log(`äº‹ä»¶: ${event} - ${JSON.stringify(data)}`);
            });
            listenedEvents++;
          } catch (error) {
            // å¿½ç•¥ä¸æ”¯æ´çš„äº‹ä»¶
          }
        });

        document.getElementById("events-info").innerHTML = `
                <div class="property">
                    <div class="property-name">ç›£è½çš„äº‹ä»¶æ•¸é‡</div>
                    <div class="property-value">${listenedEvents} / ${events.length}</div>
                </div>
                <div class="property">
                    <div class="property-name">æ”¯æ´çš„äº‹ä»¶</div>
                    <div class="property-value">æª¢æŸ¥ä¸‹æ–¹æ—¥èªŒ</div>
                </div>
            `;

        log(`é–‹å§‹ç›£è½ ${listenedEvents} å€‹äº‹ä»¶`);
      }

      // ç­‰å¾… Telegram WebApp è¼‰å…¥
      window.addEventListener("load", () => {
        setTimeout(diagnose, 100);
      });

      // å¦‚æœ Telegram å·²ç¶“è¼‰å…¥
      if (window.Telegram?.WebApp) {
        diagnose();
      }
    </script>
  </body>
</html>
